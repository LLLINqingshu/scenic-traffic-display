<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ™¯åŒºå¤±ç«è‡ªåŠ¨æŠ¥è­¦ç­ç«ç³»ç»Ÿç›‘æ§ä¸­å¿ƒ</title>
<style>
  body {
    margin:0; font-family:"Microsoft YaHei",sans-serif;
    background:linear-gradient(180deg,#0a1f3d,#051225);
    color:#e6f4ff;
  }
  header {
    background:#0c2f5c; padding:12px 24px;
    display:flex; justify-content:space-between; align-items:center;
    color:#fff; font-size:20px; font-weight:600;
  }
  .time { font-size:14px; color:#9dd1ff; }
  .layout {
    display:grid; grid-template-columns:260px 1fr 260px;
    gap:12px; padding:12px;
  }
  .card {
    background:rgba(0,40,80,0.6);
    border-radius:8px;
    padding:12px;
    box-shadow:0 0 10px rgba(0,0,0,0.5) inset;
  }
  .card h3 {
    margin:0 0 10px; font-size:16px; color:#4dc3ff;
    border-left:3px solid #4dc3ff; padding-left:8px;
  }
  .status-item {
    margin:6px 0; display:flex; justify-content:space-between;
  }
  .status-ok { color:#4dff88; }
  .status-bad { color:#ff5555; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .region {
    background:rgba(0,30,60,0.8);
    border-radius:6px; padding:20px; text-align:center;
  }
  .region span {
    display:inline-block; margin:6px; padding:12px;
    background:#00cc88; border-radius:50%; color:#fff;
  }
  .stat-box { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .stat {
    background:#002b55; border-radius:6px; padding:12px;
    text-align:center; font-size:14px;
  }
  .stat strong { display:block; font-size:18px; color:#4dc3ff; }
  .btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .btn {
    padding:12px; border-radius:6px; text-align:center; cursor:pointer;
    background:#004488; color:#fff; font-weight:600;
  }
  .btn.stop { background:#cc2222; }
  .log { font-size:13px; background:#001b33; padding:10px; border-radius:6px; max-height:200px; overflow:auto; }

  /* å·¦ä¸‹è§’å¼¹çª—å®¹å™¨ */
  .toast-container {
    position:fixed; left:20px; bottom:20px;
    display:flex; flex-direction:column;
    gap:10px; z-index:9999;
  }
  .toast {
    min-width:220px; max-width:320px;
    padding:14px 16px; border-radius:8px;
    font-weight:600; color:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
    opacity:0; transform:translateY(10px);
    animation:fadeIn .2s forwards;
  }
  @keyframes fadeIn { to {opacity:1; transform:translateY(0);} }
  .toast.fire { background:linear-gradient(90deg,#ff3b3b,#ff6a6a); }
  .toast.fire.old { background:#663333; color:#ffaaaa; }
  .toast.nofire { background:linear-gradient(90deg,#28a745,#5cd65c); }
</style>
</head>
<body>
<header>
  <div>æ™¯åŒºå¤±ç«è‡ªåŠ¨æŠ¥è­¦ç­ç«ç³»ç»Ÿç›‘æ§ä¸­å¿ƒ</div>
  <div class="time" id="time"></div>
</header>

<div class="layout">
  <!-- å·¦ä¾§ -->
  <div>
    <div class="card">
      <h3>ç³»ç»ŸçŠ¶æ€æ€»è§ˆ</h3>
      <div class="status-item"><span>ç³»ç»ŸçŠ¶æ€</span><span class="status-ok">æ­£å¸¸</span></div>
      <div class="status-item"><span>å¹³å‡æ¸©åº¦</span><span>25.4â„ƒ</span></div>
      <div class="status-item"><span>æ¹¿åº¦</span><span>2.5%</span></div>
      <div class="status-item"><span>ç­ç«æ³µå‹åŠ›</span><span>1.2MPa</span></div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>æŠ¥è­¦è®°å½•</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- ä¸­é—´ -->
  <div class="card">
    <h3>æ™¯åŒºå¹³é¢ç›‘æ§å›¾</h3>
    <div class="grid">
      <div class="region">AåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">BåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">CåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">DåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">EåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">FåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">GåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region">HåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
    </div>
  </div>

  <!-- å³ä¾§ -->
  <div>
    <div class="card">
      <h3>è®¾å¤‡çŠ¶æ€</h3>
      <div class="status-item"><span>ä¸»æ§å™¨</span><span class="status-ok">æ­£å¸¸è¿è¡Œ</span></div>
      <div class="status-item"><span>é€šä¿¡æ¨¡å—</span><span>ä¿¡å·è‰¯å¥½</span></div>
      <div class="status-item"><span>å¤‡ç”¨ç”µæº</span><span>100%</span></div>
      <div class="status-item"><span>æ°´æ³µç³»ç»Ÿ</span><span>å¾…æœº</span></div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
      <div class="stat-box">
        <div class="stat"><strong>156</strong>ä¼ æ„Ÿå™¨æ•°</div>
        <div class="stat"><strong>24</strong>å–·æ·‹å¤´æ•°</div>
        <div class="stat"><strong id="fireCount">0</strong>ç«è­¦æ¬¡æ•°</div>
        <div class="stat"><strong id="nofireCount">0</strong>è§£é™¤æ¬¡æ•°</div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>å¿«æ·æ“ä½œ</h3>
      <div class="btns">
        <div class="btn">ç³»ç»Ÿè‡ªæ£€</div>
        <div class="btn stop">ç´§æ€¥åœæ­¢</div>
        <div class="btn">é‡å¯</div>
        <div class="btn">ç”ŸæˆæŠ¥å‘Š</div>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª—å®¹å™¨ -->
<div id="toasts" class="toast-container"></div>

<!-- MQTT.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const logEl=document.getElementById("log")
  const toastContainer=document.getElementById("toasts")
  const fireCountEl=document.getElementById("fireCount")
  const nofireCountEl=document.getElementById("nofireCount")
  const TOPIC="warehouse/alarm"
  let client=null
  let fireCount=0, nofireCount=0

  function log(msg){
    const t=new Date().toLocaleTimeString()
    logEl.insertAdjacentHTML("afterbegin",`<div>[${t}] ${msg}</div>`)
  }

  function connect(){
    const url="ws://broker.emqx.io:8083/mqtt"
    const clientId="web-"+Math.random().toString(16).slice(2,8)
    client=mqtt.connect(url,{clientId})
    client.on("connect",()=>{ log("å·²è¿æ¥ "+url); client.subscribe(TOPIC) })
    client.on("message",(topic,payload)=>{
      const msg=payload.toString().trim()
      log(`æ”¶åˆ° ${topic}: ${msg}`)
      handleMsg(msg)
    })
  }

  function handleMsg(msg){
    if(msg.toLowerCase()==="fire"){ addFireToast() }
    else if(msg.toLowerCase()==="nofire"){ clearFireToasts(); addNoFireToast() }
  }

  function addFireToast(){
    // è®©å·²æœ‰ fire å˜ old
    toastContainer.querySelectorAll(".toast.fire").forEach(t=>{
      if(!t.classList.contains("old")){
        t.classList.add("old")
        setTimeout(()=>t.remove(),5000)
      }
    })
    // æ–° fire æ”¾æœ€ä¸‹é¢
    const toast=document.createElement("div")
    toast.className="toast fire"
    toast.textContent="ğŸ”¥ ç«è­¦!"
    toastContainer.appendChild(toast)

    fireCount++
    fireCountEl.textContent=fireCount
  }

  function clearFireToasts(){
    toastContainer.querySelectorAll(".toast.fire").forEach(t=>t.remove())
  }

  function addNoFireToast(){
    // æ¸…é™¤å·²æœ‰ nofire å¼¹çª—
    toastContainer.querySelectorAll(".toast.nofire").forEach(t => t.remove())

    // æ·»åŠ æ–°çš„ nofire å¼¹çª—
    const toast = document.createElement("div")
    toast.className = "toast nofire"
    toast.textContent = "âœ… å®‰å…¨ (No Fire)"
    toastContainer.appendChild(toast)
    setTimeout(() => toast.remove(), 10000)

    nofireCount++
    nofireCountEl.textContent = nofireCount
  }

  // æ—¶é—´åˆ·æ–°
  function updateTime(){
    const now=new Date()
    document.getElementById("time").textContent=
      now.getFullYear()+"/"+(now.getMonth()+1)+"/"+now.getDate()+" "+
      now.toLocaleTimeString()
  }
  setInterval(updateTime,1000); updateTime()

  window.addEventListener("load",connect)
  window.addEventListener("beforeunload",()=>{ if(client) client.end(true) })
</script>
</body>
</html>
