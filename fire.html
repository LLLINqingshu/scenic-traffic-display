<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ™¯åŒºå¤±ç«è‡ªåŠ¨æŠ¥è­¦ç­ç«ç³»ç»Ÿç›‘æ§ä¸­å¿ƒ</title>
<style>
  body {
    margin:0; font-family:"Microsoft YaHei",sans-serif;
    background:linear-gradient(180deg,#0a1f3d,#051225);
    color:#e6f4ff;
  }
  header {
    background:#0c2f5c; padding:12px 24px;
    display:flex; justify-content:space-between; align-items:center;
    color:#fff; font-size:20px; font-weight:600;
  }
  .time { font-size:14px; color:#9dd1ff; }
  .layout {
    display:grid; grid-template-columns:260px 1fr 260px;
    gap:12px; padding:12px;
  }
  .card {
    background:rgba(0,40,80,0.6);
    border-radius:8px;
    padding:12px;
    box-shadow:0 0 10px rgba(0,0,0,0.5) inset;
  }
  .card h3 {
    margin:0 0 10px; font-size:16px; color:#4dc3ff;
    border-left:3px solid #4dc3ff; padding-left:8px;
  }
  .status-item {
    margin:6px 0; display:flex; justify-content:space-between;
  }
  .status-ok { color:#4dff88; }
  .status-bad { color:#ff5555; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .region {
    background:rgba(0,30,60,0.8);
    border-radius:6px; padding:20px; text-align:center;
    transition: all 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
  }
  .region.fire-alarm {
    background: linear-gradient(145deg, #ff3333, #cc0000); /* ç«ç¾è­¦æŠ¥æ—¶çš„çº¢è‰²æ¸å˜ */
    color: #fff;
    box-shadow: 0 0 15px rgba(255, 50, 50, 0.8);
  }
  .region span {
    display:inline-block; margin:6px; padding:12px;
    background:#00cc88; border-radius:50%; color:#fff;
    transition: all 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
  }
  .region.fire-alarm span {
    background: #ff6666; /* ç«ç¾è­¦æŠ¥æ—¶spançš„é¢œè‰² */
  }
  .stat-box { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .stat {
    background:#002b55; border-radius:6px; padding:12px;
    text-align:center; font-size:14px;
  }
  .stat strong { display:block; font-size:18px; color:#4dc3ff; }
  .btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .btn {
    padding:12px; border-radius:6px; text-align:center; cursor:pointer;
    background:#004488; color:#fff; font-weight:600;
    transition: all 0.3s ease;
    user-select: none;
  }
  .btn:hover {
    background:#0055aa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  .btn.stop { background:#cc2222; }
  .btn.stop:hover { background:#dd3333; }
  .btn.selfcheck { background:#0077cc; }
  .btn.restart { background:#009933; }
  .btn.report { background:#8844aa; }
  .log { font-size:13px; background:#001b33; padding:10px; border-radius:6px; max-height:200px; overflow:auto; }

  /* å·¦ä¸‹è§’å¼¹çª—å®¹å™¨ */
  .toast-container {
    position:fixed; left:20px; bottom:20px;
    display:flex; flex-direction:column;
    gap:10px; z-index:9999;
  }
  .toast {
    min-width:220px; max-width:320px;
    padding:14px 16px; border-radius:8px;
    font-weight:600; color:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
    opacity:0; transform:translateY(10px);
    animation:fadeIn .2s forwards;
  }
  @keyframes fadeIn { to {opacity:1; transform:translateY(0);} }
  .toast.fire { background:linear-gradient(90deg,#ff3b3b,#ff6a6a); }
  .toast.fire.old { background:#663333; color:#ffaaaa; }
  .toast.nofire { background:linear-gradient(90deg,#28a745,#5cd65c); }
  
  /* æ“ä½œæˆåŠŸæç¤º */
  .toast.success { background:linear-gradient(90deg,#28a745,#5cd65c); }
  
  /* ç¡®è®¤å¯¹è¯æ¡† */
  .confirm-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 30, 60, 0.95);
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: none;
    min-width: 320px;
    border: 1px solid #004488;
  }
  .confirm-dialog.active {
    display: block;
    animation: fadeIn .3s forwards;
  }
  .confirm-dialog h4 {
    margin: 0 0 16px;
    color: #4dc3ff;
    font-size: 18px;
  }
  .confirm-dialog p {
    margin: 0 0 20px;
    color: #cce6ff;
  }
  .confirm-btns {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  .confirm-btn {
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  .confirm-btn.cancel {
    background: #666;
    color: #fff;
  }
  .confirm-btn.confirm {
    background: #cc2222;
    color: #fff;
  }
  .confirm-btn.confirm.green {
    background: #009933;
  }
  
  /* é®ç½©å±‚ */
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: none;
  }
  .overlay.active {
    display: block;
  }
</style>
</head>
<body>
<header>
  <div>æ™¯åŒºå¤±ç«è‡ªåŠ¨æŠ¥è­¦ç­ç«ç³»ç»Ÿç›‘æ§ä¸­å¿ƒ</div>
  <div class="time" id="time"></div>
</header>

<div class="layout">
  <!-- å·¦ä¾§ -->
  <div>
    <div class="card">
      <h3>ç³»ç»ŸçŠ¶æ€æ€»è§ˆ</h3>
      <div class="status-item"><span>ç³»ç»ŸçŠ¶æ€</span><span class="status-ok">æ­£å¸¸</span></div>
      <div class="status-item"><span>å¹³å‡æ¸©åº¦</span><span>25.4â„ƒ</span></div>
      <div class="status-item"><span>æ¹¿åº¦</span><span>2.5%</span></div>
      <div class="status-item"><span>ç­ç«æ³µå‹åŠ›</span><span>1.2MPa</span></div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>æŠ¥è­¦è®°å½•</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- ä¸­é—´ -->
  <div class="card">
    <h3>æ™¯åŒºå¹³é¢ç›‘æ§å›¾</h3>
    <div class="grid">
      <div class="region" id="region-a">AåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-b">BåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-c">CåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-d">DåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-e">EåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-f">FåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-g">GåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
      <div class="region" id="region-h">HåŒºåŸŸ<br><span>ä¼ æ„Ÿ</span><span>æ‘„åƒ</span></div>
    </div>
  </div>

  <!-- å³ä¾§ -->
  <div>
    <div class="card">
      <h3>è®¾å¤‡çŠ¶æ€</h3>
      <div class="status-item"><span>ä¸»æ§å™¨</span><span class="status-ok">æ­£å¸¸è¿è¡Œ</span></div>
      <div class="status-item"><span>é€šä¿¡æ¨¡å—</span><span>ä¿¡å·è‰¯å¥½</span></div>
      <div class="status-item"><span>å¤‡ç”¨ç”µæº</span><span>100%</span></div>
      <div class="status-item"><span>æ°´æ³µç³»ç»Ÿ</span><span>å¾…æœº</span></div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
      <div class="stat-box">
        <div class="stat"><strong>156</strong>ä¼ æ„Ÿå™¨æ•°</div>
        <div class="stat"><strong>24</strong>å–·æ·‹å¤´æ•°</div>
        <div class="stat"><strong id="fireCount">0</strong>ç«è­¦æ¬¡æ•°</div>
        <div class="stat"><strong id="nofireCount">0</strong>è§£é™¤æ¬¡æ•°</div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>å¿«æ·æ“ä½œ</h3>
      <div class="btns">
        <div class="btn selfcheck" id="btnSelfCheck">ç³»ç»Ÿè‡ªæ£€</div>
        <div class="btn stop" id="btnEmergencyStop">ç´§æ€¥åœæ­¢</div>
        <div class="btn restart" id="btnRestart">é‡å¯</div>
        <div class="btn report" id="btnGenerateReport">ç”ŸæˆæŠ¥å‘Š</div>
      </div>
    </div>
  </div>
</div>

<!-- å¼¹çª—å®¹å™¨ -->
<div id="toasts" class="toast-container"></div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<div id="confirmDialog" class="confirm-dialog">
  <h4 id="confirmTitle">ç¡®è®¤æ“ä½œ</h4>
  <p id="confirmMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
  <div class="confirm-btns">
    <div class="confirm-btn cancel" id="confirmCancel">å–æ¶ˆ</div>
    <div class="confirm-btn confirm" id="confirmOk">ç¡®è®¤</div>
  </div>
</div>

<!-- é®ç½©å±‚ -->
<div id="overlay" class="overlay"></div>

<!-- MQTT.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const logEl=document.getElementById("log")
  const toastContainer=document.getElementById("toasts")
  const fireCountEl=document.getElementById("fireCount")
  const nofireCountEl=document.getElementById("nofireCount")
  const TOPIC="warehouse/alarm"
  let client=null
  let fireCount=0, nofireCount=0
  
  // ç³»ç»ŸçŠ¶æ€å˜é‡
  let systemStatus = "æ­£å¸¸"
  let pumpPressure = "1.2MPa"
  let avgTemperature = "25.4â„ƒ"
  let humidity = "2.5%"
  let isSystemStopped = false
  let isSelfChecking = false

  function log(msg){
    const t=new Date().toLocaleTimeString()
    logEl.insertAdjacentHTML("afterbegin",`<div>[${t}] ${msg}</div>`)
  }

  function connect(){
    const url="ws://broker.emqx.io:8083/mqtt"
    const clientId="web-"+Math.random().toString(16).slice(2,8)
    client=mqtt.connect(url,{clientId})
    client.on("connect",()=>{ log("å·²è¿æ¥ "+url); client.subscribe(TOPIC) })
    client.on("message",(topic,payload)=>{
      const msg=payload.toString().trim()
      log(`æ”¶åˆ° ${topic}: ${msg}`)
      handleMsg(msg)
    })
  }

  function handleMsg(msg){
    if(msg.toLowerCase()==="fire"){ 
      addFireToast() 
      setRegionFireAlarm('a', true) // è®¾ç½®AåŒºåŸŸä¸ºç«ç¾é¢„è­¦çŠ¶æ€
    }
    else if(msg.toLowerCase()==="nofire"){ 
      clearFireToasts(); 
      addNoFireToast() 
      setRegionFireAlarm('a', false) // å–æ¶ˆAåŒºåŸŸçš„ç«ç¾é¢„è­¦çŠ¶æ€
    }
  }

  // è®¾ç½®æˆ–å–æ¶ˆåŒºåŸŸçš„ç«ç¾é¢„è­¦çŠ¶æ€
  function setRegionFireAlarm(regionId, isFire) {
    const regionElement = document.getElementById(`region-${regionId}`)
    if (regionElement) {
      if (isFire) {
        regionElement.classList.add('fire-alarm')
      } else {
        regionElement.classList.remove('fire-alarm')
      }
    }
  }

  function addFireToast(){
    // è®©å·²æœ‰ fire å˜ old
    toastContainer.querySelectorAll(".toast.fire").forEach(t=>{
      if(!t.classList.contains("old")){
        t.classList.add("old")
        setTimeout(()=>t.remove(),5000)
      }
    })
    // æ–° fire æ”¾æœ€ä¸‹é¢
    const toast=document.createElement("div")
    toast.className="toast fire"
    toast.textContent="ğŸ”¥ ç«è­¦! AåŒºåŸŸæ£€æµ‹åˆ°ç«ç¾"
    toastContainer.appendChild(toast)

    fireCount++
    fireCountEl.textContent=fireCount
  }

  function clearFireToasts(){
    toastContainer.querySelectorAll(".toast.fire").forEach(t=>t.remove())
  }

  function addNoFireToast(){
    // æ¸…é™¤å·²æœ‰ nofire å¼¹çª—
    toastContainer.querySelectorAll(".toast.nofire").forEach(t => t.remove())

    // æ·»åŠ æ–°çš„ nofire å¼¹çª—
    const toast = document.createElement("div")
    toast.className = "toast nofire"
    toast.textContent = "âœ… å®‰å…¨  - ç«è­¦è§£é™¤"
    toastContainer.appendChild(toast)
    setTimeout(() => toast.remove(), 10000)

    nofireCount++
    nofireCountEl.textContent = nofireCount
  }
  
  // æ·»åŠ æ“ä½œæˆåŠŸæç¤º
  function addSuccessToast(message) {
    // æ¸…é™¤å·²æœ‰çš„ç›¸åŒç±»å‹çš„å¼¹çª—
    toastContainer.querySelectorAll(".toast.success").forEach(t => t.remove())
    
    const toast = document.createElement("div")
    toast.className = "toast success"
    toast.textContent = message
    toastContainer.appendChild(toast)
    setTimeout(() => toast.remove(), 3000)
  }
  
  // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
  function updateSystemStatus() {
    const statusItems = document.querySelectorAll(".status-item span")
    statusItems[0].nextElementSibling.textContent = systemStatus
    statusItems[0].nextElementSibling.className = systemStatus === "æ­£å¸¸" ? "status-ok" : "status-bad"
    statusItems[1].nextElementSibling.textContent = avgTemperature
    statusItems[2].nextElementSibling.textContent = humidity
    statusItems[3].nextElementSibling.textContent = pumpPressure
    
    // æ›´æ–°è®¾å¤‡çŠ¶æ€
    const deviceStatusItems = document.querySelectorAll(".card:nth-child(1) .status-item span")
    deviceStatusItems[0].nextElementSibling.textContent = isSystemStopped ? "å·²åœæ­¢" : "æ­£å¸¸è¿è¡Œ"
    deviceStatusItems[0].nextElementSibling.className = isSystemStopped ? "status-bad" : "status-ok"
    deviceStatusItems[3].nextElementSibling.textContent = isSystemStopped ? "å·²å…³é—­" : "å¾…æœº"
  }
  
  // ç³»ç»Ÿè‡ªæ£€åŠŸèƒ½
  function systemSelfCheck() {
    if (isSelfChecking) {
      log("ç³»ç»Ÿè‡ªæ£€æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...")
      return
    }
    
    isSelfChecking = true
    log("å¼€å§‹ç³»ç»Ÿè‡ªæ£€...")
    
    // æ¨¡æ‹Ÿè‡ªæ£€è¿‡ç¨‹
    const checkSteps = [
      {name: "æ£€æŸ¥ä¼ æ„Ÿå™¨ç½‘ç»œ", time: 1000},
      {name: "æ£€æŸ¥é€šä¿¡æ¨¡å—", time: 800},
      {name: "æ£€æŸ¥å¤‡ç”¨ç”µæº", time: 600},
      {name: "æ£€æŸ¥æ°´æ³µç³»ç»Ÿ", time: 1200},
      {name: "æ£€æŸ¥ç­ç«è£…ç½®", time: 1000}
    ]
    
    let stepIndex = 0
    
    function performNextStep() {
      if (stepIndex >= checkSteps.length) {
        // è‡ªæ£€å®Œæˆ
        log("ç³»ç»Ÿè‡ªæ£€å®Œæˆï¼Œæ‰€æœ‰è®¾å¤‡æ­£å¸¸")
        isSelfChecking = false
        addSuccessToast("âœ… ç³»ç»Ÿè‡ªæ£€å®Œæˆï¼Œæ‰€æœ‰è®¾å¤‡æ­£å¸¸")
        return
      }
      
      const step = checkSteps[stepIndex]
      log(`æ­£åœ¨${step.name}...`)
      
      setTimeout(() => {
        log(`${step.name}å®Œæˆï¼ŒçŠ¶æ€æ­£å¸¸`)
        stepIndex++
        performNextStep()
      }, step.time)
    }
    
    performNextStep()
  }
  
  // ç´§æ€¥åœæ­¢åŠŸèƒ½
  function emergencyStop() {
    if (isSystemStopped) {
      log("ç³»ç»Ÿå·²ç»å¤„äºåœæ­¢çŠ¶æ€")
      return
    }
    
    showConfirmDialog(
      "ç´§æ€¥åœæ­¢ç³»ç»Ÿ",
      "æ‚¨ç¡®å®šè¦ç´§æ€¥åœæ­¢æ•´ä¸ªç³»ç»Ÿå—ï¼Ÿè¿™å°†åœæ­¢æ‰€æœ‰è‡ªåŠ¨ç­ç«åŠŸèƒ½ã€‚",
      () => {
        isSystemStopped = true
        systemStatus = "å·²åœæ­¢"
        pumpPressure = "0.0MPa"
        log("ç³»ç»Ÿå·²ç´§æ€¥åœæ­¢")
        updateSystemStatus()
        addSuccessToast("ğŸ›‘ ç³»ç»Ÿå·²ç´§æ€¥åœæ­¢")
        
        // æ¨¡æ‹Ÿ5ç§’åè‡ªåŠ¨æ¢å¤
        setTimeout(() => {
          if (isSystemStopped) {
            isSystemStopped = false
            systemStatus = "æ­£å¸¸"
            pumpPressure = "1.2MPa"
            log("ç³»ç»Ÿå·²è‡ªåŠ¨æ¢å¤è¿è¡Œ")
            updateSystemStatus()
            addSuccessToast("ğŸ”„ ç³»ç»Ÿå·²è‡ªåŠ¨æ¢å¤è¿è¡Œ")
          }
        }, 5000)
      }
    )
  }
  
  // é‡å¯ç³»ç»ŸåŠŸèƒ½
  function restartSystem() {
    if (isSystemStopped) {
      log("ç³»ç»Ÿå·²åœæ­¢ï¼Œæ­£åœ¨é‡å¯...")
      isSystemStopped = false
      systemStatus = "é‡å¯ä¸­..."
      pumpPressure = "0.0MPa"
      updateSystemStatus()
      
      // æ¨¡æ‹Ÿé‡å¯è¿‡ç¨‹
      setTimeout(() => {
        systemStatus = "æ­£å¸¸"
        pumpPressure = "1.2MPa"
        log("ç³»ç»Ÿé‡å¯å®Œæˆ")
        updateSystemStatus()
        addSuccessToast("ğŸ”„ ç³»ç»Ÿé‡å¯å®Œæˆ")
      }, 3000)
    } else {
      showConfirmDialog(
        "é‡å¯ç³»ç»Ÿ",
        "æ‚¨ç¡®å®šè¦é‡å¯ç³»ç»Ÿå—ï¼Ÿé‡å¯è¿‡ç¨‹éœ€è¦çº¦3ç§’é’Ÿã€‚",
        () => {
          log("å¼€å§‹é‡å¯ç³»ç»Ÿ...")
          systemStatus = "é‡å¯ä¸­..."
          pumpPressure = "0.0MPa"
          updateSystemStatus()
          
          // æ¨¡æ‹Ÿé‡å¯è¿‡ç¨‹
          setTimeout(() => {
            systemStatus = "æ­£å¸¸"
            pumpPressure = "1.2MPa"
            log("ç³»ç»Ÿé‡å¯å®Œæˆ")
            updateSystemStatus()
            addSuccessToast("ğŸ”„ ç³»ç»Ÿé‡å¯å®Œæˆ")
          }, 3000)
        }
      )
    }
  }
  
  // ç”ŸæˆæŠ¥å‘ŠåŠŸèƒ½
  function generateReport() {
    log("æ­£åœ¨ç”Ÿæˆç³»ç»ŸæŠ¥å‘Š...")
    
    // æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆè¿‡ç¨‹
    setTimeout(() => {
      const reportContent = `
        æ™¯åŒºæ¶ˆé˜²ç³»ç»ŸæŠ¥å‘Š
        ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}
        
        ç³»ç»ŸçŠ¶æ€: ${systemStatus}
        ç«è­¦æ¬¡æ•°: ${fireCount}
        è§£é™¤æ¬¡æ•°: ${nofireCount}
        ä¼ æ„Ÿå™¨æ•°: 156
        å–·æ·‹å¤´æ•°: 24
        å¹³å‡æ¸©åº¦: ${avgTemperature}
        æ¹¿åº¦: ${humidity}
        ç­ç«æ³µå‹åŠ›: ${pumpPressure}
        
        æœ€è¿‘äº‹ä»¶:
        ${getRecentLogs(5)}
      `
      
      log("ç³»ç»ŸæŠ¥å‘Šå·²ç”Ÿæˆ")
      
      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥è°ƒç”¨ä¸‹è½½åŠŸèƒ½
      // æ¨¡æ‹Ÿä¸‹è½½æŠ¥å‘Š
      const blob = new Blob([reportContent], {type: 'text/plain'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `æ¶ˆé˜²ç³»ç»ŸæŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.txt`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)
      
      addSuccessToast("ğŸ“„ ç³»ç»ŸæŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸‹è½½")
    }, 1500)
  }
  
  // è·å–æœ€è¿‘çš„æ—¥å¿—
  function getRecentLogs(count) {
    const logItems = logEl.querySelectorAll('div')
    let result = ''
    const limit = Math.min(count, logItems.length)
    
    for (let i = 0; i < limit; i++) {
      result += logItems[i].textContent + '\n'
    }
    
    return result
  }
  
  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  function showConfirmDialog(title, message, confirmCallback) {
    const dialog = document.getElementById('confirmDialog')
    const overlay = document.getElementById('overlay')
    const titleEl = document.getElementById('confirmTitle')
    const messageEl = document.getElementById('confirmMessage')
    const cancelBtn = document.getElementById('confirmCancel')
    const confirmBtn = document.getElementById('confirmOk')
    
    titleEl.textContent = title
    messageEl.textContent = message
    
    // è®¾ç½®ç¡®è®¤æŒ‰é’®æ ·å¼
    if (title.includes('åœæ­¢')) {
      confirmBtn.className = 'confirm-btn confirm'
    } else {
      confirmBtn.className = 'confirm-btn confirm green'
    }
    
    // æ˜¾ç¤ºå¯¹è¯æ¡†å’Œé®ç½©å±‚
    dialog.classList.add('active')
    overlay.classList.add('active')
    
    // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
    const cancelHandler = () => {
      dialog.classList.remove('active')
      overlay.classList.remove('active')
      log("æ“ä½œå·²å–æ¶ˆ")
    }
    
    const confirmHandler = () => {
      dialog.classList.remove('active')
      overlay.classList.remove('active')
      confirmCallback()
    }
    
    // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
    cancelBtn.onclick = cancelHandler
    confirmBtn.onclick = confirmHandler
    overlay.onclick = cancelHandler
    
    // ESCé”®å…³é—­å¯¹è¯æ¡†
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        cancelHandler()
        document.removeEventListener('keydown', escHandler)
      }
    }
    
    document.addEventListener('keydown', escHandler)
  }
  
  // ç»‘å®šæŒ‰é’®äº‹ä»¶
  function bindButtonEvents() {
    document.getElementById('btnSelfCheck').addEventListener('click', systemSelfCheck)
    document.getElementById('btnEmergencyStop').addEventListener('click', emergencyStop)
    document.getElementById('btnRestart').addEventListener('click', restartSystem)
    document.getElementById('btnGenerateReport').addEventListener('click', generateReport)
  }

  // æ—¶é—´åˆ·æ–°
  function updateTime(){
    const now=new Date()
    document.getElementById("time").textContent=
      now.getFullYear()+"/"+(now.getMonth()+1)+"/"+now.getDate()+" "+
      now.toLocaleTimeString()
  }
  setInterval(updateTime,1000); updateTime()

  window.addEventListener("load", () => {
    connect()
    bindButtonEvents()
    // åˆå§‹åŒ–æ—¥å¿—
    log("ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼Œç›‘æ§ä¸­å¿ƒå·²å°±ç»ª")
    log("ç­‰å¾…è¿æ¥MQTTæœåŠ¡å™¨...")
  })
  window.addEventListener("beforeunload",()=>{ if(client) client.end(true) })
</script>
</body>
</html>
